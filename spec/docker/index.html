<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <meta name="author" content="Daniel NÃ¼st, Matthias Schutzeichel, Markus Konkol">  
    <link rel="shortcut icon" href="../../img/favicon.ico">

    <title>Docker Runtime Extension - ERC spec</title>

    <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/font-hack/2.018/css/hack.min.css">
    <link href='//fonts.googleapis.com/css?family=PT+Sans:400,400italic,700,700italic&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,700italic,400,300,600,700&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
    <link href="../../css/base.css" rel="stylesheet">
    <link href="../../css/cinder.css" rel="stylesheet">
    <link rel="stylesheet" href="../../css/highlight.css">


    <link href="../../erc.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

    <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.5.18/webfont.js"></script>
    <script>
    WebFont.load({
        google: {
            families: ['Open Sans', 'PT Sans']
        }
    });
    </script>

    
</head>

<body>

    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->
            <a class="navbar-brand" href="../..">ERC spec</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                    <li >
                        <a href="../..">Home</a>
                    </li>
                
                
                
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">ERC <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../">Specification</a>
</li>

                        
                            
<li class="active">
    <a href="./">Docker Runtime Extension</a>
</li>

                        
                            
<li >
    <a href="../archival/">Archival Extension</a>
</li>

                        
                            
<li >
    <a href="../valid/">Validation Extension</a>
</li>

                        
                            
<li >
    <a href="../r/">R Extension</a>
</li>

                        
                            
<li >
    <a href="../man/">Manipulation Extension</a>
</li>

                        
                            
<li >
    <a href="../plain_r/">Plain R Runtime Extension</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">User guide <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../user-guide/creation/">ERC creation guide</a>
</li>

                        
                            
<li >
    <a href="../../user-guide/template/">ERC template</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li >
                        <a href="../../dev-guide/">Developer guide</a>
                    </li>
                
                
                
                    <li >
                        <a href="../../glossary/">Glossary</a>
                    </li>
                
                
                </ul>
            

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                
                    <li >
                        <a rel="next" href="../">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../archival/">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
                
                
                    <li>
                        <a href="https://github.com/o2r-project/erc-spec">
                            
                                <i class="fa fa-github"></i>
                            
                            GitHub
                        </a>
                    </li>
                
            </ul>
        </div>
    </div>
</div>

    <div class="container">
        
        <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="first-level active"><a href="#docker-runtime-extension">Docker runtime extension</a></li>
        
            <li class="second-level"><a href="#dockerfile">Dockerfile</a></li>
            
                <li class="third-level"><a href="#making-data-code-and-text-available-within-container">Making data, code, and text available within container</a></li>
            
                <li class="third-level"><a href="#example-dockerfile">Example Dockerfile</a></li>
            
        
            <li class="second-level"><a href="#docker-image">Docker image</a></li>
            
        
            <li class="second-level"><a href="#control-statements">Control statements</a></li>
            
        
    
    </ul>
</div></div>
        <div class="col-md-9" role="main">

<h1 id="docker-runtime-extension">Docker runtime extension</h1>
<p>This extension uses <a href="http://docker.com/">Docker</a> to define, build, and store the runtime environment.</p>
<p>The <em>runtime environment or image</em> MUST be represented by a <a href="https://github.com/docker/docker/blob/master/image/spec/v1.2.md">Docker image v1.2.0</a>.</p>
<p>The <em>runtime manifest</em> MUST be represented by a <code>Dockerfile</code>, see <a href="https://docs.docker.com/engine/reference/builder/">Docker builder reference</a>, as defined in version <a href="https://github.com/docker/docker/blob/1.12.x/docs/reference/builder.md"><code>1.12.x</code></a>.</p>
<h2 id="dockerfile">Dockerfile</h2>
<p>The base directory MUST contain a valid Dockerfile, see <a href="https://docs.docker.com/engine/reference/builder/">Dockerfile reference</a>.</p>
<p>The Dockerfile MUST contain the build instructions for the runtime environment and MUST have been used to create the image saved to the <a href="#runtime-container-file">runtime container file</a> using <code>docker build</code>, see <a href="https://docs.docker.com/engine/reference/commandline/build/">Docker CLI build command documentation</a>, as defined in version <a href="https://github.com/docker/docker/blob/1.12.x/docs/reference/commandline/build.md"><code>1.12.x</code></a>.
The build SHOULD be done with the option <code>--no-cache=true</code>.</p>
<p>The file SHOULD be named <code>Dockerfile</code>.
Differing file names MUST be specified in the extension metadata, the exact node is left implementation-specific.</p>
<p>The Dockerfile MUST contain the required instruction <code>FROM</code>, which MUST NOT use the <code>latest</code> tag.</p>
<p>The Dockerfile SHOULD contain the instruction <code>MAINTAINER</code> to provide copyright information.</p>
<p>The Dockerfile MUST have an active instruction <code>CMD</code>, or a combination of the instructions <code>ENTRYPOINT</code> and <code>CMD</code>, which executes the packaged analysis.</p>
<p>The Dockerfile SHOULD NOT contain <code>EXPOSE</code> instructions.</p>
<h3 id="making-data-code-and-text-available-within-container">Making data, code, and text available within container</h3>
<p>The runtime environment image contains all dependencies and libraries needed by the code in an ERC.
Especially for large datasets, it in unfeasible to replicate the complete dataset contained within the ERC in the image.
For archival, it can also be confusing to replicate code and text, albeit them being relatively small in size, within the container.</p>
<p>Therefore a host directory is <a href="https://docs.docker.com/engine/reference/commandline/run/#mount-volume--v---read-only">mounted into a container</a> at runtime using a <a href="https://docs.docker.com/engine/tutorials/dockervolumes/#mount-a-host-directory-as-a-data-volume">data volume</a>.</p>
<p>The Dockerfile SHOULD NOT contain a <code>COPY</code> or <code>ADD</code> command to include data, code or text from the ERC into the image.</p>
<p>The Dockerfile MUST contain a <code>VOLUME</code> instruction to define the mount point of the ERC base directory within the container.
This mountpoint SHOULD be <code>/erc</code>.
Implementations MUST use this value as the default.
If the mountpoint is different from <code>/erc</code>, the value MUST be defined in <code>erc.yml</code> in a node <code>execution.mount_point</code>.</p>
<p>Example for the mountpoint configuration:</p>
<pre><code class="yml">---
id: b9b0099e-9f8d-4a33-8acf-cb0c062efaec
spec_version: 1
execution:
  mount_point: &quot;/erc&quot;
</code></pre>

<h3 id="example-dockerfile">Example Dockerfile</h3>
<p>In this example we use a <a href="https://github.com/rocker-org/rocker"><em>Rocker</em></a> base image to reproduce computations made in R.</p>
<pre><code class="Dockerfile">FROM rocker/r-ver:3.3.3
MAINTAINER o2r

RUN apt-get update -qq \
    &amp;&amp; apt-get install -y --no-install-recommends \
    ## Packages required by R extension packages
    # required by rmarkdown:
    lmodern \
    pandoc \
    # for devtools (requires git2r, httr):
    libcurl4-openssl-dev \
    libssl-dev \
    git \
    # for udunits:
    libudunits2-0 \
    libudunits2-dev \
    # required when knitting the document
    pandoc-citeproc \
    &amp;&amp; apt-get clean \
    &amp;&amp; rm -rf /var/lib/apt/lists/*

# install R extension packages
RUN install2.r -r &quot;http://cran.rstudio.com&quot; \
      rmarkdown \
      ggplot2 \
      devtools \
      &amp;&amp; rm -rf /tmp/downloaded_packages/ /tmp/*.rd

# Save installed packages to file
RUN dpkg -l &gt; /dpkg-list.txt

LABEL Description=&quot;This is an ERC image.&quot; \
    info.o2r.bag.id=&quot;123456&quot;

VOLUME [&quot;/erc&quot;]

ENTRYPOINT [&quot;sh&quot;, &quot;-c&quot;]
CMD [&quot;R --vanilla -e \&quot;rmarkdown::render(input = '/erc/myPaper.rmd', output_dir = '/erc', output_format = rmarkdown::html_document())\&quot;&quot;]
</code></pre>

<p>See also: <a href="https://docs.docker.com/engine/userguide/eng-image/dockerfile_best-practices/#run">Best practices for writing Dockerfiles</a>.</p>
<h2 id="docker-image">Docker image</h2>
<p>The base directory MUST contain a <a href="https://en.wikipedia.org/wiki/Tar_(computing)">tarball</a>, i.e. an archive file, of a Docker image as created be the command <code>docker save</code>, see <a href="https://docs.docker.com/engine/reference/commandline/save/">Docker CLI save command documentation</a>, as defined in version <a href="https://github.com/docker/docker/blob/1.12.x/docs/reference/commandline/save.md"><code>1.12.x</code></a>.</p>
<p>The image MUST have a <a href="https://docs.docker.com/engine/reference/commandline/build/#options"><em>label</em></a> of the name <code>erc</code> with the ERC's id as value, e.g. <code>erc=b9b0099e-9f8d-4a33-8acf-cb0c062efaec</code>.</p>
<p>The name of the archive file MAY be configured in the ERC configuration file in the node <code>image</code> under the root-level node <code>execution</code>.</p>
<p>The default tar archive file names SHOULD be <code>image.tar</code>, or <code>image.tar.gz</code> if a <a href="https://en.wikipedia.org/wiki/Tar_(computing)#Suffixes_for_compressed_files">gzip compression is used for the archive</a>.
Implementations MUST recognize these names as the default values.</p>
<div class="alert note" markdown="block">
Before exporting the Docker image, first [build it](https://docs.docker.com/engine/reference/commandline/build/) from the Dockerfile, including the label which can be used to extract the image identifier, for example:

<pre>
<code>
docker build --label erc=b9b0099e-9f8d-4a33-8acf-cb0c062efaec .
docker images --filter "label=erc=b9b0099e-9f8d-4a33-8acf-cb0c062efaec"
docker save $(docker images --filter "label=erc=1234" -q) > image.tar
# save with compression:
docker save $(docker images --filter "label=erc=1234" -q) | gzip -c > image.tar.gz
</code>
</pre>

Do _not_ use <code>docker export</code>, because it is used to create a snapshot of a container, which must not match the Dockerfile anymore as it may have been manipulated during a run.
</div>

<h2 id="control-statements">Control statements</h2>
<p>The control statements for Docker executions comprise <code>load</code>, for importing an image from the archive, and <code>run</code> for starting a container of the loaded image.
Both control statements MUST be configured by using nodes of the same name under the root-level node <code>execution</code> in the ERC configuration file.
Based on the configuration, an implementation can construct the respective run-time commands, i.e. <a href="https://docs.docker.com/engine/reference/commandline/load/"><code>docker load</code></a> and <a href="https://docs.docker.com/engine/reference/run/"><code>docker run</code></a>, using the correct image file name and further parameters (e.g. performance control options).</p>
<p>The following example shows default values for <code>image</code> and <code>manifest</code> and typical values for <code>run</code>.</p>
<pre><code class="yml">id: b9b0099e-9f8d-4a33-8acf-cb0c062efaec
version: 1
execution:
  image: image.tar.gz
  manifest: Dockerfile
  run:
    environment:
      - TZ=CET
</code></pre>

<div class="alert note" markdown="block">
The Docker CLI commands constructed based on this configuration by an implementing service could be as follows:

<pre>
<code>
docker load --input image.tar
IMAGE_ID=$(docker images --filter "label=erc=b9b0099e-9f8d-4a33-8acf-cb0c062efaec" -q)
docker run -it --name run_abc123 -e TZ=CET -v /storage/erc/abc123:/erc --label user:o2r $IMAGE_ID
</code>
</pre>

In this case the implementation uses <code>-it</code> to pass stdout streams to the user and adds some metadata using <code>--name</code> and <code>--label</code>.
</div>

<p>The only option for <code>load</code> is <code>quiet</code>, which may be set to Boolean <code>true</code> or <code>false</code>.</p>
<pre><code class="yml">execution:
  load:
    quiet: true
</code></pre>

<p>The only option for <code>run</code> is <code>environment</code> to set environment variables inside containers as defined in <a href="https://docs.docker.com/compose/environment-variables/#setting-environment-variables-in-containers">docker-compose</a>.
Environment variables are defined as a list seperated by <code>=</code>.</p>
<pre><code class="yml">execution:
  run:
    environment:
      - DEBUG=1
      - TZ=CET
</code></pre>

<p>The environment variables SHOULD be used to fix settings out of control of the contained code that can hinder successful ERC checking, e.g. by setting a time zone to avoid issues during checking.</p>
<p>The output of the container during execution MAY be shown to the user to convey detailed information to users.</p></div>
        
    </div>

    <footer class="col-md-12 text-center">
        <hr>
        <p>
        <small>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p></small>
    </footer>

    <script src="../../js/jquery-1.10.2.min.js"></script>
    <script src="../../js/bootstrap-3.0.3.min.js"></script>
    <script src="../../js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script>
    var base_url = '../..';
    </script>
    <script data-main="../../mkdocs/js/search.js" src="../../mkdocs/js/require.js"></script>
    <script src="../../js/base.js"></script>

    <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                        <span class="sr-only">Close</span>
                    </button>
                    <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                </div>
                <div class="modal-body">
                    <p>
                        From here you can search these documents. Enter your search terms below.
                    </p>
                    <form role="form">
                        <div class="form-group">
                            <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                        </div>
                    </form>
                    <div id="mkdocs-search-results"></div>
                </div>
                <div class="modal-footer">
                </div>
            </div>
        </div>
    </div>

    </body>

</html>
